{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}QA Analytics - Question Answering System{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Analytics Header -->
<div class="analytics-header">
    <div class="container">
        <div class="row align-items-center py-4">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-chart-line me-3"></i>
                    QA System Analytics
                </h1>
                <p class="page-subtitle">
                    Performance metrics and usage analytics for the Question Answering system
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <button class="btn btn-outline-secondary" id="exportBtn">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                </div>
                <a href="{% url 'question_answering:qa_interface' %}" class="btn btn-outline-primary ms-2">
                    <i class="fas fa-arrow-left me-2"></i>Back to QA
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Time Range Selector -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="time-range-selector">
                <label class="form-label">Time Range</label>
                <select class="form-select" id="timeRange">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <div class="date-range-selector">
                <label class="form-label">Custom Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="startDate">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="endDate">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="totalSessions">-</div>
                    <div class="metric-label">Total Sessions</div>
                    <div class="metric-change" id="sessionsChange">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="text-success">+12%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="totalQueries">-</div>
                    <div class="metric-label">Total Queries</div>
                    <div class="metric-change" id="queriesChange">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="text-success">+8%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="successRate">-</div>
                    <div class="metric-label">Success Rate</div>
                    <div class="metric-change" id="successChange">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span class="text-success">+3%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="avgResponseTime">-</div>
                    <div class="metric-label">Avg Response Time</div>
                    <div class="metric-change" id="responseTimeChange">
                        <i class="fas fa-arrow-down text-success"></i>
                        <span class="text-success">-15%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="chart-card">
                <div class="chart-header">
                    <h5>Query Volume Over Time</h5>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-secondary active" data-chart="volume">Volume</button>
                        <button class="btn btn-sm btn-outline-secondary" data-chart="success">Success Rate</button>
                        <button class="btn btn-sm btn-outline-secondary" data-chart="response">Response Time</button>
                    </div>
                </div>
                <div class="chart-content">
                    <canvas id="timeSeriesChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-card">
                <div class="chart-header">
                    <h5>Query Types Distribution</h5>
                </div>
                <div class="chart-content">
                    <canvas id="queryTypesChart" width="300" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-card">
                <div class="chart-header">
                    <h5>User Satisfaction</h5>
                </div>
                <div class="chart-content">
                    <canvas id="satisfactionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-card">
                <div class="chart-header">
                    <h5>System Performance</h5>
                </div>
                <div class="chart-content">
                    <div class="performance-metrics">
                        <div class="performance-item">
                            <div class="performance-label">Knowledge Base Coverage</div>
                            <div class="performance-bar">
                                <div class="performance-fill" style="width: 85%"></div>
                            </div>
                            <div class="performance-value">85%</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">AI Model Accuracy</div>
                            <div class="performance-bar">
                                <div class="performance-fill" style="width: 92%"></div>
                            </div>
                            <div class="performance-value">92%</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">Response Relevance</div>
                            <div class="performance-bar">
                                <div class="performance-fill" style="width: 88%"></div>
                            </div>
                            <div class="performance-value">88%</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-label">System Uptime</div>
                            <div class="performance-bar">
                                <div class="performance-fill" style="width: 99%"></div>
                            </div>
                            <div class="performance-value">99%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Tables -->
    <div class="row">
        <div class="col-md-6">
            <div class="table-card">
                <div class="table-header">
                    <h5>Top Performing Sessions</h5>
                </div>
                <div class="table-content">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Session</th>
                                    <th>Queries</th>
                                    <th>Success Rate</th>
                                    <th>Satisfaction</th>
                                </tr>
                            </thead>
                            <tbody id="topSessionsTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="table-card">
                <div class="table-header">
                    <h5>Recent Activity</h5>
                </div>
                <div class="table-content">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Query Type</th>
                                    <th>Response Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.analytics-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-bottom: 2rem;
}

.metric-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.2s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.metric-content {
    flex: 1;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    line-height: 1;
}

.metric-label {
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 0.25rem;
}

.metric-change {
    font-size: 0.8rem;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.chart-card, .table-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.chart-header, .table-header {
    padding: 1.5rem 1.5rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chart-header h5, .table-header h5 {
    margin: 0;
    color: #333;
    font-weight: 600;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.chart-controls .btn {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
}

.chart-controls .btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.chart-content, .table-content {
    padding: 1.5rem;
}

.performance-metrics {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.performance-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.performance-label {
    flex: 1;
    font-size: 0.9rem;
    color: #333;
}

.performance-bar {
    flex: 2;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.performance-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    transition: width 0.3s ease;
}

.performance-value {
    font-weight: 600;
    color: #333;
    min-width: 40px;
    text-align: right;
}

.table-card .table {
    margin-bottom: 0;
}

.table-card .table th {
    border-top: none;
    font-weight: 600;
    color: #333;
    font-size: 0.85rem;
}

.table-card .table td {
    font-size: 0.85rem;
    vertical-align: middle;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-success {
    background: #d4edda;
    color: #155724;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
}

/* Responsive Design */
@media (max-width: 768px) {
    .metric-card {
        flex-direction: column;
        text-align: center;
    }
    
    .chart-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .performance-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .performance-bar {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
class QAAnalytics {
    constructor() {
        this.charts = {};
        this.currentTimeRange = 30;
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadAnalytics();
    }
    
    bindEvents() {
        // Time range selector
        document.getElementById('timeRange').addEventListener('change', (e) => {
            this.currentTimeRange = parseInt(e.target.value);
            this.loadAnalytics();
        });
        
        // Date range selector
        document.getElementById('startDate').addEventListener('change', () => {
            this.loadAnalytics();
        });
        
        document.getElementById('endDate').addEventListener('change', () => {
            this.loadAnalytics();
        });
        
        // Chart controls
        document.querySelectorAll('[data-chart]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const chartType = e.target.dataset.chart;
                this.switchChart(chartType);
            });
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.loadAnalytics();
        });
        
        // Export button
        document.getElementById('exportBtn').addEventListener('click', () => {
            this.exportAnalytics();
        });
    }
    
    async loadAnalytics() {
        try {
            const params = new URLSearchParams({
                days: this.currentTimeRange
            });
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate) {
                params.set('start_date', startDate);
                params.set('end_date', endDate);
            }
            
            const response = await fetch(`/api/qa/analytics/?${params}`);
            if (response.ok) {
                const data = await response.json();
                this.updateMetrics(data);
                this.updateCharts(data);
                this.updateTables(data);
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }
    
    updateMetrics(data) {
        document.getElementById('totalSessions').textContent = data.total_sessions || 0;
        document.getElementById('totalQueries').textContent = data.total_queries || 0;
        document.getElementById('successRate').textContent = `${(data.success_rate || 0).toFixed(1)}%`;
        document.getElementById('avgResponseTime').textContent = `${(data.average_response_time || 0).toFixed(1)}s`;
    }
    
    updateCharts(data) {
        this.createTimeSeriesChart(data);
        this.createQueryTypesChart(data);
        this.createSatisfactionChart(data);
    }
    
    createTimeSeriesChart(data) {
        const ctx = document.getElementById('timeSeriesChart').getContext('2d');
        
        if (this.charts.timeSeries) {
            this.charts.timeSeries.destroy();
        }
        
        // Sample data - replace with actual data from API
        const labels = this.generateDateLabels(this.currentTimeRange);
        const volumeData = this.generateSampleData(labels.length, 10, 50);
        const successData = this.generateSampleData(labels.length, 70, 95);
        const responseData = this.generateSampleData(labels.length, 1, 5);
        
        this.charts.timeSeries = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Query Volume',
                    data: volumeData,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    createQueryTypesChart(data) {
        const ctx = document.getElementById('queryTypesChart').getContext('2d');
        
        if (this.charts.queryTypes) {
            this.charts.queryTypes.destroy();
        }
        
        const queryTypes = data.query_type_distribution || [];
        const labels = queryTypes.map(item => item.query_type.replace('_', ' '));
        const values = queryTypes.map(item => item.count);
        
        this.charts.queryTypes = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#007bff',
                        '#28a745',
                        '#ffc107',
                        '#dc3545',
                        '#6f42c1',
                        '#20c997'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    createSatisfactionChart(data) {
        const ctx = document.getElementById('satisfactionChart').getContext('2d');
        
        if (this.charts.satisfaction) {
            this.charts.satisfaction.destroy();
        }
        
        // Sample satisfaction data
        const satisfactionData = [5, 15, 25, 35, 20]; // Ratings 1-5
        
        this.charts.satisfaction = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                datasets: [{
                    data: satisfactionData,
                    backgroundColor: [
                        '#dc3545',
                        '#fd7e14',
                        '#ffc107',
                        '#20c997',
                        '#28a745'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    switchChart(chartType) {
        // Update active button
        document.querySelectorAll('[data-chart]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-chart="${chartType}"]`).classList.add('active');
        
        // Update chart data based on type
        // This would update the time series chart with different data
    }
    
    updateTables(data) {
        this.updateTopSessionsTable(data);
        this.updateRecentActivityTable(data);
    }
    
    updateTopSessionsTable(data) {
        const tbody = document.getElementById('topSessionsTable');
        
        // Sample data - replace with actual data
        const topSessions = [
            { title: 'Constitutional Law Research', queries: 25, success_rate: 92, satisfaction: 4.5 },
            { title: 'Criminal Procedure Analysis', queries: 18, success_rate: 88, satisfaction: 4.2 },
            { title: 'Civil Law Consultation', queries: 15, success_rate: 95, satisfaction: 4.8 }
        ];
        
        tbody.innerHTML = topSessions.map(session => `
            <tr>
                <td>${this.escapeHtml(session.title)}</td>
                <td>${session.queries}</td>
                <td>
                    <span class="badge bg-success">${session.success_rate}%</span>
                </td>
                <td>
                    <span class="badge bg-primary">${session.satisfaction}/5</span>
                </td>
            </tr>
        `).join('');
    }
    
    updateRecentActivityTable(data) {
        const tbody = document.getElementById('recentActivityTable');
        
        // Sample data - replace with actual data
        const recentActivity = [
            { time: '2 min ago', type: 'Case Inquiry', response_time: 2.3, status: 'success' },
            { time: '5 min ago', type: 'Law Research', response_time: 1.8, status: 'success' },
            { time: '8 min ago', type: 'Judge Inquiry', response_time: 3.1, status: 'success' },
            { time: '12 min ago', type: 'Court Procedure', response_time: 2.7, status: 'success' }
        ];
        
        tbody.innerHTML = recentActivity.map(activity => `
            <tr>
                <td>${activity.time}</td>
                <td>${activity.type}</td>
                <td>${activity.response_time}s</td>
                <td>
                    <span class="status-badge status-${activity.status}">
                        ${activity.status === 'success' ? 'Success' : 'Error'}
                    </span>
                </td>
            </tr>
        `).join('');
    }
    
    generateDateLabels(days) {
        const labels = [];
        const today = new Date();
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        }
        
        return labels;
    }
    
    generateSampleData(length, min, max) {
        const data = [];
        for (let i = 0; i < length; i++) {
            data.push(Math.floor(Math.random() * (max - min + 1)) + min);
        }
        return data;
    }
    
    async exportAnalytics() {
        try {
            const params = new URLSearchParams({
                days: this.currentTimeRange,
                format: 'json'
            });
            
            const response = await fetch(`/api/qa/analytics/?${params}`);
            if (response.ok) {
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `qa_analytics_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        } catch (error) {
            console.error('Error exporting analytics:', error);
        }
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Initialize analytics
const qaAnalytics = new QAAnalytics();
</script>
{% endblock %}
